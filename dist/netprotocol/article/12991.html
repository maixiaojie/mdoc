<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>趣谈网络协议</title>
    <meta name="description" content="Talking about Network Protocol">
    <link rel="icon" href="/netprotocol/logo.png">
    
    <link rel="preload" href="/netprotocol/assets/css/0.styles.8ed81d4f.css" as="style"><link rel="preload" href="/netprotocol/assets/js/app.a42fbc22.js" as="script"><link rel="preload" href="/netprotocol/assets/js/21.18ac33b5.js" as="script"><link rel="prefetch" href="/netprotocol/assets/js/10.b137334e.js"><link rel="prefetch" href="/netprotocol/assets/js/11.f81a1afe.js"><link rel="prefetch" href="/netprotocol/assets/js/12.a3d3f02e.js"><link rel="prefetch" href="/netprotocol/assets/js/13.6f45434d.js"><link rel="prefetch" href="/netprotocol/assets/js/14.4373e971.js"><link rel="prefetch" href="/netprotocol/assets/js/15.bba6998c.js"><link rel="prefetch" href="/netprotocol/assets/js/16.fda5f416.js"><link rel="prefetch" href="/netprotocol/assets/js/17.8b2ce630.js"><link rel="prefetch" href="/netprotocol/assets/js/18.39838a6e.js"><link rel="prefetch" href="/netprotocol/assets/js/19.ced40dbf.js"><link rel="prefetch" href="/netprotocol/assets/js/2.5e23b1e3.js"><link rel="prefetch" href="/netprotocol/assets/js/20.dc1009fb.js"><link rel="prefetch" href="/netprotocol/assets/js/22.f92681cb.js"><link rel="prefetch" href="/netprotocol/assets/js/23.167adbf1.js"><link rel="prefetch" href="/netprotocol/assets/js/24.8900bbcf.js"><link rel="prefetch" href="/netprotocol/assets/js/25.330a47bc.js"><link rel="prefetch" href="/netprotocol/assets/js/26.ee198c03.js"><link rel="prefetch" href="/netprotocol/assets/js/27.49077d84.js"><link rel="prefetch" href="/netprotocol/assets/js/28.969912e2.js"><link rel="prefetch" href="/netprotocol/assets/js/29.0ab6db51.js"><link rel="prefetch" href="/netprotocol/assets/js/3.7da37368.js"><link rel="prefetch" href="/netprotocol/assets/js/30.f0f9e81e.js"><link rel="prefetch" href="/netprotocol/assets/js/31.b23a44cb.js"><link rel="prefetch" href="/netprotocol/assets/js/32.60bfb2fa.js"><link rel="prefetch" href="/netprotocol/assets/js/33.5f11c77a.js"><link rel="prefetch" href="/netprotocol/assets/js/34.89bbb6bb.js"><link rel="prefetch" href="/netprotocol/assets/js/35.1dd49070.js"><link rel="prefetch" href="/netprotocol/assets/js/36.f3bf019a.js"><link rel="prefetch" href="/netprotocol/assets/js/37.25799f73.js"><link rel="prefetch" href="/netprotocol/assets/js/38.3008dfdf.js"><link rel="prefetch" href="/netprotocol/assets/js/39.c71d98ea.js"><link rel="prefetch" href="/netprotocol/assets/js/4.a80811a8.js"><link rel="prefetch" href="/netprotocol/assets/js/40.659ae002.js"><link rel="prefetch" href="/netprotocol/assets/js/41.e8d258e6.js"><link rel="prefetch" href="/netprotocol/assets/js/42.97402baf.js"><link rel="prefetch" href="/netprotocol/assets/js/43.457f305d.js"><link rel="prefetch" href="/netprotocol/assets/js/44.6c2906f4.js"><link rel="prefetch" href="/netprotocol/assets/js/45.dfdf5a0e.js"><link rel="prefetch" href="/netprotocol/assets/js/46.8ead4a08.js"><link rel="prefetch" href="/netprotocol/assets/js/47.42ec58e7.js"><link rel="prefetch" href="/netprotocol/assets/js/48.c2d6747a.js"><link rel="prefetch" href="/netprotocol/assets/js/49.678b4eba.js"><link rel="prefetch" href="/netprotocol/assets/js/5.55ab3fc9.js"><link rel="prefetch" href="/netprotocol/assets/js/50.f1ad00b4.js"><link rel="prefetch" href="/netprotocol/assets/js/51.aa8a0c2d.js"><link rel="prefetch" href="/netprotocol/assets/js/52.ea53ee59.js"><link rel="prefetch" href="/netprotocol/assets/js/53.66bb194f.js"><link rel="prefetch" href="/netprotocol/assets/js/54.15d306c1.js"><link rel="prefetch" href="/netprotocol/assets/js/6.aeaee4ea.js"><link rel="prefetch" href="/netprotocol/assets/js/7.85695bf5.js"><link rel="prefetch" href="/netprotocol/assets/js/8.544243b8.js"><link rel="prefetch" href="/netprotocol/assets/js/9.4618c319.js">
    <link rel="stylesheet" href="/netprotocol/assets/css/0.styles.8ed81d4f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/netprotocol/" class="home-link router-link-active"><!----> <span class="site-name">趣谈网络协议</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netprotocol/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  重学前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/ds/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  数据结构与算法之美
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/jvm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入拆解 Java 虚拟机
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/air/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  左耳听风
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/blockchain/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入浅出区块链
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netprotocol/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  重学前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/ds/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  数据结构与算法之美
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/jvm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入拆解 Java 虚拟机
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/air/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  左耳听风
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/blockchain/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入浅出区块链
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/netprotocol/article/7398.html" class="sidebar-link">开篇词 | 想成为技术牛人？先搞定网络协议！</a></li><li><a href="/netprotocol/article/7581.html" class="sidebar-link">第1讲 | 为什么要学习网络协议？</a></li><li><a href="/netprotocol/article/7724.html" class="sidebar-link">第2讲 | 网络分层的真实含义是什么？</a></li><li><a href="/netprotocol/article/7772.html" class="sidebar-link">第3讲 | ifconfig：最熟悉又陌生的命令行</a></li><li><a href="/netprotocol/article/8015.html" class="sidebar-link">第4讲 | DHCP与PXE：IP是怎么来的，又是怎么没的？</a></li><li><a href="/netprotocol/article/8094.html" class="sidebar-link">第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？</a></li><li><a href="/netprotocol/article/8386.html" class="sidebar-link">第6讲 | 交换机与VLAN：办公室太复杂，我要回学校</a></li><li><a href="/netprotocol/article/8445.html" class="sidebar-link">第7讲 | ICMP与ping：投石问路的侦察兵</a></li><li><a href="/netprotocol/article/8590.html" class="sidebar-link">第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行</a></li><li><a href="/netprotocol/article/8729.html" class="sidebar-link">第9讲 | 路由协议：西出网关无故人，敢问路在何方</a></li><li><a href="/netprotocol/article/8924.html" class="sidebar-link">第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”</a></li><li><a href="/netprotocol/article/8975.html" class="sidebar-link">第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松</a></li><li><a href="/netprotocol/article/9141.html" class="sidebar-link">第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难</a></li><li><a href="/netprotocol/article/9293.html" class="sidebar-link">第13讲 | 套接字Socket：Talk is cheap, show me the code</a></li><li><a href="/netprotocol/article/9410.html" class="sidebar-link">第14讲 | HTTP协议：看个新闻原来这么麻烦</a></li><li><a href="/netprotocol/article/9492.html" class="sidebar-link">第15讲 | HTTPS协议：点外卖的过程原来这么复杂</a></li><li><a href="/netprotocol/article/9688.html" class="sidebar-link">第16讲 | 流媒体协议：如何在直播里看到美女帅哥？</a></li><li><a href="/netprotocol/article/9707.html" class="sidebar-link">第17讲 | P2P协议：我下小电影，99%急死你</a></li><li><a href="/netprotocol/article/9895.html" class="sidebar-link">第18讲 | DNS协议：网络世界的地址簿</a></li><li><a href="/netprotocol/article/9938.html" class="sidebar-link">第19讲 | HTTPDNS：网络世界的地址簿也会指错路</a></li><li><a href="/netprotocol/article/10085.html" class="sidebar-link">第20讲 | CDN：你去小卖部取过快递么？</a></li><li><a href="/netprotocol/article/10098.html" class="sidebar-link">第21讲 | 数据中心：我是开发商，自己拿地盖别墅</a></li><li><a href="/netprotocol/article/10386.html" class="sidebar-link">第22讲 | VPN：朝中有人好做官</a></li><li><a href="/netprotocol/article/10534.html" class="sidebar-link">第23讲 | 移动网络：去巴塞罗那，手机也上不了脸书</a></li><li><a href="/netprotocol/article/10742.html" class="sidebar-link">第24讲 | 云中网络：自己拿地成本高，购买公寓更灵活</a></li><li><a href="/netprotocol/article/10755.html" class="sidebar-link">第25讲 | 软件定义网络：共享基础设施的小区物业管理办法</a></li><li><a href="/netprotocol/article/10978.html" class="sidebar-link">第26讲 | 云中的网络安全：虽然不是土豪，也需要基本安全和保障</a></li><li><a href="/netprotocol/article/10994.html" class="sidebar-link">第27讲 | 云中的网络QoS：邻居疯狂下电影，我该怎么办？</a></li><li><a href="/netprotocol/article/11324.html" class="sidebar-link">第28讲 | 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私</a></li><li><a href="/netprotocol/article/11465.html" class="sidebar-link">第29讲 | 容器网络：来去自由的日子，不买公寓去合租</a></li><li><a href="/netprotocol/article/11643.html" class="sidebar-link">第30讲 | 容器网络之Flannel：每人一亩三分地</a></li><li><a href="/netprotocol/article/11940.html" class="sidebar-link">第31讲 | 容器网络之Calico：为高效说出善意的谎言</a></li><li><a href="/netprotocol/article/12230.html" class="sidebar-link">第32讲 | RPC协议综述：远在天边，近在眼前</a></li><li><a href="/netprotocol/article/12388.html" class="sidebar-link">第33讲 | 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛</a></li><li><a href="/netprotocol/article/12512.html" class="sidebar-link">第34讲 | 基于JSON的RESTful接口协议：我不关心过程，请给我结果</a></li><li><a href="/netprotocol/article/12521.html" class="sidebar-link">第35讲 | 二进制类RPC协议：还是叫NBA吧，总说全称多费劲</a></li><li><a href="/netprotocol/article/12819.html" class="sidebar-link">第36讲 | 跨语言类RPC协议：交流之前，双方先来个专业术语表</a></li><li><a href="/netprotocol/article/12991.html" class="active sidebar-link">第37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/netprotocol/article/12991.html#_1-部署一个高可用高并发的电商平台" class="sidebar-link">1.部署一个高可用高并发的电商平台</a></li><li class="sidebar-sub-header"><a href="/netprotocol/article/12991.html#_2-大声告诉全世界，可以到我这里买东西" class="sidebar-link">2.大声告诉全世界，可以到我这里买东西</a></li><li class="sidebar-sub-header"><a href="/netprotocol/article/12991.html#_3-打开手机来上网，域名解析得地址" class="sidebar-link">3.打开手机来上网，域名解析得地址</a></li></ul></li><li><a href="/netprotocol/article/12996.html" class="sidebar-link">第38讲 | 知识串讲：用双十一的故事串起碎片的网络协议（中）</a></li><li><a href="/netprotocol/article/13099.html" class="sidebar-link">第39讲 | 知识串讲：用双十一的故事串起碎片的网络协议（下）</a></li><li><a href="/netprotocol/article/13124.html" class="sidebar-link">第40讲 | 搭建一个网络实验环境：授人以鱼不如授人以渔</a></li><li><a href="/netprotocol/article/13520.html" class="sidebar-link">协议专栏特别福利 | 答疑解惑第一期</a></li><li><a href="/netprotocol/article/13847.html" class="sidebar-link">协议专栏特别福利 | 答疑解惑第二期</a></li><li><a href="/netprotocol/article/14028.html" class="sidebar-link">协议专栏特别福利 | 答疑解惑第三期</a></li><li><a href="/netprotocol/article/14194.html" class="sidebar-link">协议专栏特别福利 | 答疑解惑第四期</a></li><li><a href="/netprotocol/article/14381.html" class="sidebar-link">协议专栏特别福利 | 答疑解惑第五期</a></li><li><a href="/netprotocol/article/14384.html" class="sidebar-link">测一测 | 这些网络协议你都掌握了吗？</a></li><li><a href="/netprotocol/article/14553.html" class="sidebar-link">结束语 | 放弃完美主义，执行力就是限时限量认真完成</a></li><li><a href="/netprotocol/article/17846.html" class="sidebar-link">我是如何创作“趣谈网络协议”专栏的？</a></li><li><a href="/netprotocol/article/17862.html" class="sidebar-link">“趣谈网络协议”专栏「食用指南」</a></li></ul> </div> <div class="page"> <div class="content"><p>基本的网络知识我们都讲完了，还记得最初举的那个“双十一”下单的例子吗？这一节开始，我们详细地讲解这个过程，用这个过程串起我们讲过的网络协议。</p> <p>我把这个过程分为十个阶段，从云平台中搭建一个电商开始，到BGP路由广播，再到DNS域名解析，从客户看商品图片，到最终下单的整个过程，每一步我都会详细讲解。这节我们先来看前三个阶段。</p> <h2 id="_1-部署一个高可用高并发的电商平台"><a href="#_1-部署一个高可用高并发的电商平台" aria-hidden="true" class="header-anchor">#</a> 1.部署一个高可用高并发的电商平台</h2> <p>首先，咱们<strong>要有个电商平台</strong>。假设我们已经有了一个特别大的电商平台，这个平台应该部署在哪里呢？假设我们用公有云，一般公有云会有多个位置，比如在华东、华北、华南都有。毕竟咱们的电商是要服务全国的，当然到处都要部署了。我们把主站点放在华东。</p> <p><img src="https://static001.geekbang.org/resource/image/ed/20/eddde5929de2a72b197321e5ad87e120.jpg" alt></p> <p>为了每个点都能“雨露均沾”，也为了高可用性，往往需要有多个机房，形成多个可用区（Available Zone）。由于咱们的应用是分布在两个可用区的，所以假如任何一个可用区挂了，都不会受影响。</p> <p>我们来回想<a href="https://time.geekbang.org/column/article/10098" target="_blank" rel="noopener noreferrer">数据中心<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>那一节，每个可用区里有一片一片的机柜，每个机柜上有一排一排的服务器，每个机柜都有一个接入交换机，有一个汇聚交换机将多个机柜连在一起。</p> <p>这些服务器里面部署的都是计算节点，每台上面都有Open vSwitch创建的虚拟交换机，将来在这台机器上创建的虚拟机，都会连到Open vSwitch上。</p> <p><img src="https://static001.geekbang.org/resource/image/d6/a7/d66c01c39e911e784525a118c37b50a7.jpg" alt></p> <p>接下来，你<strong>在云计算的界面上创建一个VPC</strong>（Virtual Private Cloud，虚拟私有网络），指定一个IP段，这样以后你部署的所有应用都会在这个虚拟网络里，使用你分配的这个IP段。为了不同的VPC相互隔离，每个VPC都会被分配一个VXLAN的ID。尽管不同用户的虚拟机有可能在同一个物理机上，但是不同的VPC二层压根儿是不通的。</p> <p>由于有两个可用区，在这个VPC里面，要为每一个可用区分配一个Subnet，也就是在大的网段里分配两个小的网段。当两个可用区里面网段不同的时候，就可以配置路由策略，访问另外一个可用区，走某一条路由了。</p> <p>接下来，应该<strong>创建数据库持久化层</strong>。大部分云平台都会提供PaaS服务，也就是说，不需要你自己搭建数据库，而是采用直接提供数据库的服务，并且单机房的主备切换都是默认做好的，数据库也是部署在虚拟机里面的，只不过从界面上，你看不到数据库所在的虚拟机而已。</p> <p>云平台会给每个Subnet的数据库实例分配一个域名。创建数据库实例的时候，需要你指定可用区和Subnet，这样创建出来的数据库实例可以通过这个Subnet的私网IP进行访问。</p> <p>为了分库分表实现高并发的读写，在创建的多个数据库实例之上，会<strong>创建一个分布式数据库的实例</strong>，也需要指定可用区和Subnet，还会为分布式数据库分配一个私网IP和域名。</p> <p>对于数据库这种高可用性比较高的，需要进行跨机房高可用，因而两个可用区都要部署一套，但是只有一个是主，另外一个是备，云平台往往会提供数据库同步工具，将应用写入主的数据同步给备数据库集群。</p> <p>接下来是<strong>创建缓存集</strong>群。云平台也会提供PaaS服务，也需要每个可用区和Subnet创建一套，缓存的数据在内存中，由于读写性能要求高，一般不要求跨可用区读写。</p> <p>再往上层就是<strong>部署咱们自己写的程序</strong>了。基础服务层、组合服务层、Controller层，以及Nginx层、API网关等等，这些都是部署在虚拟机里面的。它们之间通过RPC相互调用，需要到注册中心进行注册。</p> <p>它们之间的网络通信是虚拟机和虚拟机之间的。如果是同一台物理机，则那台物理机上的OVS就能转发过去；如果是不同的物理机，这台物理机的OVS和另一台物理机的OVS中间有一个VXLAN的隧道，将请求转发过去。</p> <p>再往外就是<strong>负载均衡</strong>了，负载均衡也是云平台提供的PaaS服务，也是属于某个VPC的，部署在虚拟机里面的，但是负载均衡有个外网的IP，这个外网的IP地址就是在网关节点的外网网口上的。在网关节点上，会有NAT规则，将外网IP地址转换为VPC里面的私网IP地址，通过这些私网IP地址访问到虚拟机上的负载均衡节点，然后通过负载均衡节点转发到API网关的节点。</p> <p>网关节点的外网网口是带公网IP地址的，里面有一个虚拟网关转发模块，还会有一个OVS，将私网IP地址放到VXLAN隧道里面，转发到虚拟机上，从而实现外网和虚拟机网络之间的互通。</p> <p>不同的可用区之间，通过核心交换机连在一起，核心交换机之外是边界路由器。</p> <p>在华北、华东、华南同样也部署了一整套，每个地区都创建了VPC，这就需要有一种机制将VPC连接到一起。云平台一般会提供硬件的VPC互连的方式，当然也可以使用软件互连的方式，也就是使用VPN网关，通过IPsec VPN将不同地区的不同VPC通过VPN连接起来。</p> <p>对于不同地区和不同运营商的用户，我们希望他能够就近访问到网站，而且当一个点出了故障之后，我们希望能够在不同的地区之间切换，这就需要有智能DNS，这个也是云平台提供的。</p> <p>对于一些静态资源，可以保持在对象存储里面，通过CDN下发到边缘节点，这样客户端就能尽快加载出来。</p> <h2 id="_2-大声告诉全世界，可以到我这里买东西"><a href="#_2-大声告诉全世界，可以到我这里买东西" aria-hidden="true" class="header-anchor">#</a> 2.大声告诉全世界，可以到我这里买东西</h2> <p>当电商应用搭建完毕之后，接下来需要将如何访问到这个电商网站广播给全网。</p> <p>刚才那张图画的是一个可用区的情况，对于多个可用区的情况，我们可以隐去计算节点的情况，将外网访问区域放大。</p> <p><img src="https://static001.geekbang.org/resource/image/e1/24/e132bc3ba500b1197139f30c02e20124.jpg" alt></p> <p>外网IP是放在虚拟网关的外网网口上的，这个IP如何让全世界知道呢？当然是通过BGP路由协议了。</p> <p>每个可用区都有自己的汇聚交换机，如果机器数目比较多，可以直接用核心交换机，每个Region也有自己的核心交换区域。</p> <p>在核心交换外面是安全设备，然后就是边界路由器。边界路由器会和多个运营商连接，从而每个运营商都能够访问到这个网站。边界路由器可以通过BGP协议，将自己数据中心里面的外网IP向外广播，也就是告诉全世界，如果要访问这些外网IP，都来我这里。</p> <p>每个运营商也有很多的路由器、很多的点，于是就可以将如何到达这些IP地址的路由信息，广播到全国乃至全世界。</p> <h2 id="_3-打开手机来上网，域名解析得地址"><a href="#_3-打开手机来上网，域名解析得地址" aria-hidden="true" class="header-anchor">#</a> 3.打开手机来上网，域名解析得地址</h2> <p>这个时候，不但你的这个网站的IP地址全世界都知道了，你打的广告可能大家也都看到了，于是有客户下载App来买东西了。</p> <p><img src="https://static001.geekbang.org/resource/image/85/fc/85c125c225faba29c0f374e18ea8c6fc.jpg" alt></p> <p>客户的手机开机以后，在附近寻找基站eNodeB，发送请求，申请上网。基站将请求发给MME，MME对手机进行认证和鉴权，还会请求HSS看有没有钱，看看是在哪里上网。</p> <p>当MME通过了手机的认证之后，开始建立隧道，建设的数据通路分两段路，其实是两个隧道。一段是从eNodeB到SGW，第二段是从SGW到PGW，在PGW之外，就是互联网。</p> <p>PGW会为手机分配一个IP地址，手机上网都是带着这个IP地址的。</p> <p>当在手机上面打开一个App的时候，首先要做的事情就是解析这个网站的域名。</p> <p>在手机运营商所在的互联网区域里，有一个本地的DNS，手机会向这个DNS请求解析DNS。当这个DNS本地有缓存，则直接返回；如果没有缓存，本地DNS才需要递归地从根DNS服务器，查到.com的顶级域名服务器，最终查到权威DNS服务器。</p> <p>如果你使用云平台的时候，配置了智能DNS和全局负载均衡，在权威DNS服务中，一般是通过配置CNAME的方式，我们可以起一个别名，例如 <a href="http://vip.yourcomany.com" target="_blank" rel="noopener noreferrer">vip.yourcomany.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，然后告诉本地DNS服务器，让它请求GSLB解析这个域名，GSLB就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。</p> <p>GSLB通过查看请求它的本地DNS服务器所在的运营商和地址，就知道用户所在的运营商和地址，然后将距离用户位置比较近的Region里面，三个负载均衡SLB的公网IP地址，返回给本地DNS服务器。本地DNS解析器将结果缓存后，返回给客户端。</p> <p>对于手机App来说，可以绕过刚才的传统DNS解析机制，直接只要HTTPDNS服务，通过直接调用HTTPDNS服务器，得到这三个SLB的公网IP地址。</p> <p>看，经过了如此复杂的过程，咱们的万里长征还没迈出第一步，刚刚得到IP地址，包还没发呢？话说手机App拿到了公网IP地址，接下来应该做什么呢？</p> <p>欢迎你留言和我讨论。趣谈网络协议，我们下期见！</p> <p><img src="https://static001.geekbang.org/resource/image/b5/fb/b5bc14cb81d3630919fee94a512cc3fb.jpg" alt></p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/netprotocol/article/12819.html" class="prev">
          第36讲 | 跨语言类RPC协议：交流之前，双方先来个专业术语表
        </a></span> <span class="next"><a href="/netprotocol/article/12996.html">
          第38讲 | 知识串讲：用双十一的故事串起碎片的网络协议（中）
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/netprotocol/assets/js/app.a42fbc22.js" defer></script><script src="/netprotocol/assets/js/21.18ac33b5.js" defer></script>
  </body>
</html>
