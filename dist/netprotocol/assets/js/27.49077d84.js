(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{186:function(t,e,r){"use strict";r.r(e);var _=r(0),n=Object(_.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"content"},[r("p",[t._v("你好，我是刘超。")]),t._v(" "),r("p",[t._v("第三期答疑涵盖第7讲至第13讲的内容。我依旧对课后思考题和留言中比较有代表性的问题作出回答。你可以点击文章名，回到对应的章节复习，也可以继续在留言区写下你的疑问，我会持续不断地解答。希望对你有帮助。")]),t._v(" "),r("h2",{attrs:{id:"《第7讲-icmp与ping：投石问路的侦察兵》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第7讲-icmp与ping：投石问路的侦察兵》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8445",target:"_blank",rel:"noopener noreferrer"}},[t._v("《"),r("OutboundLink")],1),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8445",target:"_blank",rel:"noopener noreferrer"}},[t._v("第7讲 | ICMP与ping：投石问路的侦察兵"),r("OutboundLink")],1),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8445",target:"_blank",rel:"noopener noreferrer"}},[t._v("》"),r("OutboundLink")],1)]),t._v(" "),t._m(0),t._v(" "),r("p",[t._v("当发送的报文出问题的时候，会发送一个ICMP的差错报文来报告错误，但是如果 ICMP 的差错报文也出问题了呢？")]),t._v(" "),r("p",[t._v("我总结了一下，不会导致产生ICMP差错报文的有：")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),r("p",[t._v("1.ping使用的是什么网络编程接口？")]),t._v(" "),t._m(3),t._v(" "),r("p",[t._v("咱们使用的网络编程接口是Socket，对于ping来讲，使用的是ICMP，创建Socket如下：")]),t._v(" "),t._m(4),t._v(" "),r("p",[t._v("SOCK_RAW就是基于IP层协议建立通信机制。")]),t._v(" "),r("p",[t._v("如果是TCP，则建立下面的Socket：")]),t._v(" "),t._m(5),t._v(" "),r("p",[t._v("如果是UDP，则建立下面的Socket：")]),t._v(" "),t._m(6),t._v(" "),r("p",[t._v("2.ICMP差错报文是谁发送的呢？")]),t._v(" "),r("p",[t._v("我看留言里有很多人对这个问题有疑惑。ICMP包是由内核返回的，在内核中，有一个函数用于发送ICMP的包。")]),t._v(" "),t._m(7),t._v(" "),r("p",[t._v("例如，目标不可达，会调用下面的函数。")]),t._v(" "),t._m(8),t._v(" "),r("p",[t._v("当IP大小超过MTU的时候，发送需要分片的ICMP。")]),t._v(" "),t._m(9),t._v(" "),r("h2",{attrs:{id:"《第8讲-世界这么大，我想出网关：欧洲十国游与玄奘西行》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第8讲-世界这么大，我想出网关：欧洲十国游与玄奘西行》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8590",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行》"),r("OutboundLink")],1)]),t._v(" "),t._m(10),t._v(" "),r("p",[t._v("当在你家里要访问 163 网站的时候，你的包需要 NAT 成为公网 IP，返回的包又要 NAT 成你的私有 IP，返回包怎么知道这是你的请求呢？它怎么能这么智能的 NAT 成了你的 IP 而非别人的 IP 呢？")]),t._v(" "),r("p",[t._v("这是个比较复杂的事情。在讲云中网络安全里的iptables时，我们讲过conntrack功能，它记录了SNAT一去一回的对应关系。")]),t._v(" "),r("p",[t._v("如果编译内核时开启了连接跟踪选项，那么Linux系统就会为它收到的每个数据包维持一个连接状态，用于记录这条数据连接的状态。")]),t._v(" "),t._m(11),t._v(" "),r("p",[t._v("根据咱们学过的Netfilter的流程图，我们知道，网络包有三种路径：")]),t._v(" "),t._m(12),t._v(" "),r("p",[t._v("如果要跟踪一个网络包，对于每一种路径，都需要设置两个记录点，相当于打两次卡，这样内核才知道这个包的状态。")]),t._v(" "),r("p",[t._v("对于这三种路径，打卡的点是这样设置的：")]),t._v(" "),t._m(13),t._v(" "),r("p",[t._v("网关主要做转发，这里主要说的是NAT网关，因而我们重点来看“从我这里经过的”这种场景，再加上要NAT，因而将NAT的过程融入到连接跟踪的过程中来：")]),t._v(" "),t._m(14),t._v(" "),r("p",[t._v("接下来，我们来看，在这个过程中涉及到的数据结构：连接跟踪记录、连接跟踪表。")]),t._v(" "),r("p",[t._v("在前面讲网络包处理的时候，我们说过，每个网络包都是一个struct sk_buff，它有一个成员变量_nfct指向一个连接跟踪记录struct nf_conn。当然当一个网络包刚刚进来的时候，是不会指向这么一个结构的，但是这个网络包肯定属于某个连接，因而会去连接跟踪表里面去查找，之后赋值给sk_buff的这个成员变量。没找到的话，就说明是一个新的连接，然后会重新创建一个。")]),t._v(" "),r("p",[t._v("连接跟踪记录里面有几个重要的东西：")]),t._v(" "),t._m(15),t._v(" "),r("p",[t._v("在这里面，最重要的是nf_conntrack_tuple_hash的数组。nf_conn是这个网络包对应的一去一回的连接追踪记录，但是这个记录是会放在一个统一的连接追踪表里面的。")]),t._v(" "),r("p",[t._v("连接跟踪表nf_conntrack_hash是一个数组，数组中的每一项都是一个双向链表的头，每一项后面都挂着一个双向链表，链表中的每一项都是这个结构。")]),t._v(" "),r("p",[t._v("这个结构的第一项是链表的链，nf_conntrack_tuple是用来标识是否同一个连接。")]),t._v(" "),r("p",[t._v("从上面可以看出来，连接跟踪表是一个典型的链式哈希表的实现。")]),t._v(" "),r("p",[t._v("每当有一个网络包来了的时候，会将网络包中sk_buff中的数据提取出来，形成nf_conntrack_tuple，并根据里面的内容计算哈希值。然后需要在哈希表中查找，如果找到，则说明这个连接出现过；如果没找到，则生成一个插入哈希表。")]),t._v(" "),r("p",[t._v("通过nf_conntrack_tuple里面的内容，可以唯一地标识一个连接：")]),t._v(" "),t._m(16),t._v(" "),r("p",[t._v("有了这些数据结构，我们接下来看这一去一回的过程。")]),t._v(" "),r("p",[t._v("当一个包发出去的时候，到达这个NAT网关的时候，首先经过PREROUTING的时候，先调用ipv4_conntrack_in。这个时候进来的包sk_buff为： {源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}，将这个转换为nf_conntrack_tuple，然后经过哈希运算，在连接跟踪表里面查找，发现没有，说明这是一个新的连接。")]),t._v(" "),r("p",[t._v("于是，创建一个新的连接跟踪记录nf_conn，这里面有两个nf_conntrack_tuple_hash：")]),t._v(" "),t._m(17),t._v(" "),r("p",[t._v("接下来经过FORWARD过程，假设包没有被filter掉，于是要转发出去，进入POSTROUTING的过程，有NAT规则，则调用nf_nat_ipv4_out进行地址转换。这个时候，源地址要变成NAT网关的IP地址，对于masquerade来讲，会自动选择一个公网IP地址和一个随机端口。")]),t._v(" "),r("p",[t._v("为了让包回来的时候，能找到连接跟踪记录，需要修改两个nf_conntrack_tuple_hash中回来的那一项为：{源IP：服务端IP，源端口：服务端port，目标IP：NAT网关IP，目标端口：随机端口}。")]),t._v(" "),r("p",[t._v("接下来要将网络包真正发出去的时候，除了要修改包里面的源IP和源端口之外，还需要将刚才的一去一回的两个nf_conntrack_tuple_hash放入连接跟踪表这个哈希表中。")]),t._v(" "),r("p",[t._v("当网络包到达服务端，然后回复一个包的时候，这个包sk_buff为：{源IP：服务端IP，源端口：服务端port，目标IP：NAT网关IP，目标端口：随机端口}。")]),t._v(" "),r("p",[t._v("将这个转换为nf_conntrack_tuple后，进行哈希运算，在连接跟踪表里面查找，是能找到相应的记录的，找到nf_conntrack_tuple_hash之后，Linux会提供一个函数。")]),t._v(" "),t._m(18),t._v(" "),r("p",[t._v("可以通过nf_conntrack_tuple_hash找到外面的连接跟踪记录nf_conn，通过这个可以找到来方向的那个nf_conntrack_tuple_hash，{源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}，这样就能够找到客户端的IP和端口，从而可以NAT回去。")]),t._v(" "),t._m(19),t._v(" "),r("p",[t._v("1.NAT能建立多少连接？")]),t._v(" "),t._m(20),t._v(" "),r("p",[t._v("SNAT多用于内网访问外网的场景，鉴于conntrack是由{源IP，源端口，目标IP，目标端口}，hash后确定的。")]),t._v(" "),r("p",[t._v("如果内网机器很多，但是访问的是不同的外网，也即目标IP和目标端口很多，这样内网可承载的数量就非常大，可不止65535个。")]),t._v(" "),r("p",[t._v("但是如果内网所有的机器，都一定要访问同一个目标IP和目标端口，这样源IP如果只有一个，这样的情况下，才受65535的端口数目限制，根据原理，一种方法就是多个源IP，另外的方法就是多个NAT网关，来分摊不同的内网机器访问。")]),t._v(" "),r("p",[t._v("如果你使用的是公有云，65535台机器，应该放在一个VPC里面，可以放在多个VPC里面，每个VPC都可以有自己的NAT网关。")]),t._v(" "),t._m(21),t._v(" "),r("p",[t._v("其实SNAT的场景是内网访问外网，存在端口数量的问题，也是所有的机器都访问一个目标地址的情况。")]),t._v(" "),r("p",[t._v("如果是微信这种场景，应该是服务端在数据中心内部，无论多少长连接，作为服务端监听的都是少数几个端口，是DNAT的场景，是没有端口数目问题的，只有一台服务器能不能维护这么多连接，因而在NAT网关后面部署多个nginx来分摊连接即可。")]),t._v(" "),r("p",[t._v("2.公网IP和私网IP需要一一绑定吗？")]),t._v(" "),t._m(22),t._v(" "),r("p",[t._v("公网IP是有限的，如果使用公有云，需要花钱去买。但是不是每一个虚拟机都要有一个公网IP的，只有需要对外提供服务的机器，也即接入层的那些nginx需要公网IP，没有公网IP，使用SNAT，大家共享SNAT网关的公网IP地址，也是能够访问的外网的。")]),t._v(" "),r("p",[t._v("我看留言中的困惑点都在于，要区分内主动发起访问外，还是外主动发起访问内，是访问同一个服务端，还是访问一大批服务端。这里就很明白了。")]),t._v(" "),r("h2",{attrs:{id:"《第9讲-路由协议：西出网关无故人，敢问路在何方》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第9讲-路由协议：西出网关无故人，敢问路在何方》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8729",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第9讲 | 路由协议：西出网关无故人，敢问路在何方》"),r("OutboundLink")],1)]),t._v(" "),t._m(23),t._v(" "),r("p",[t._v("路由协议要在路由器之间交换信息，这些信息的交换还需要走路由吗？不是死锁了吗？")]),t._v(" "),t._m(24),t._v(" "),r("p",[t._v("OSPF是直接基于IP协议发送的，而且OSPF的包都是发给邻居的，也即只有一跳，不会中间经过路由设备。BGP是基于TCP协议的，在BGP peer之间交换信息。")]),t._v(" "),t._m(25),t._v(" "),r("p",[t._v("1.多线BGP机房是怎么回事儿？")]),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),r("p",[t._v("使用此方案来实现多线路互联，IDC需要在CNNIC（中国互联网信息中心）或APNIC（亚太网络信息中心）申请自己的IP地址段和AS号，然后通过BGP协议将此段IP地址广播到其它的网络运营商的网络中。")]),t._v(" "),r("p",[t._v("使用BGP协议互联后，网络运营商的所有骨干路由设备将会判断到IDC机房IP段的最佳路由，以保证不同网络运营商用户的高速访问。")]),t._v(" "),r("h2",{attrs:{id:"《第10讲-udp协议：因性善而简单，难免碰到“城会玩”》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第10讲-udp协议：因性善而简单，难免碰到“城会玩”》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8924",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”》"),r("OutboundLink")],1)]),t._v(" "),t._m(28),t._v(" "),r("p",[t._v("都说 TCP 是面向连接的，在计算机看来，怎么样才算一个连接呢？")]),t._v(" "),r("p",[t._v("赵强强在留言中回答的是正确的。这是TCP的两端为了维护连接所保持的数据结构。")]),t._v(" "),t._m(29),t._v(" "),t._m(30),t._v(" "),r("h2",{attrs:{id:"《第11讲-tcp协议（上）：因性恶而复杂，先恶后善反轻松》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第11讲-tcp协议（上）：因性恶而复杂，先恶后善反轻松》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/8975",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松》"),r("OutboundLink")],1)]),t._v(" "),t._m(31),t._v(" "),r("p",[t._v("TCP 的连接有这么多的状态，你知道如何在系统中查看某个连接的状态吗？")]),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),r("p",[t._v("1.TIME_WAIT状态太多是怎么回事儿？")]),t._v(" "),t._m(34),t._v(" "),t._m(35),t._v(" "),r("p",[t._v("如果处于TIMEWAIT状态，说明双方建立成功过连接，而且已经发送了最后的ACK之后，才会处于这个状态，而且是主动发起关闭的一方处于这个状态。")]),t._v(" "),r("p",[t._v("如果存在大量的TIMEWAIT，往往是因为短连接太多，不断的创建连接，然后释放连接，从而导致很多连接在这个状态，可能会导致无法发起新的连接。解决的方式往往是：")]),t._v(" "),t._m(36),t._v(" "),r("p",[t._v("当客户端收到Connection Reset，往往是收到了TCP的RST消息，RST消息一般在下面的情况下发送：")]),t._v(" "),t._m(37),t._v(" "),r("p",[t._v("2.起始序列号是怎么计算的，会冲突吗？")]),t._v(" "),r("p",[t._v("有同学在留言中问了几个问题。Ender0224的回答非常不错。")]),t._v(" "),t._m(38),t._v(" "),t._m(39),t._v(" "),r("p",[t._v("起始ISN是基于时钟的，每4毫秒加一，转一圈要4.55个小时。")]),t._v(" "),r("p",[t._v("TCP初始化序列号不能设置为一个固定值，因为这样容易被攻击者猜出后续序列号，从而遭到攻击。 RFC1948中提出了一个较好的初始化序列号ISN随机生成算法。")]),t._v(" "),r("p",[t._v("ISN = M + F (localhost, localport, remotehost, remoteport)")]),t._v(" "),r("p",[t._v("M是一个计时器，这个计时器每隔4毫秒加1。F是一个Hash算法，根据源IP、目的IP、源端口、目的端口生成一个随机数值。要保证Hash算法不能被外部轻易推算得出，用MD5算法是一个比较好的选择。")]),t._v(" "),r("h2",{attrs:{id:"《第12讲-tcp协议（下）：西行必定多妖孽，恒心智慧消磨难》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第12讲-tcp协议（下）：西行必定多妖孽，恒心智慧消磨难》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/9141",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难》"),r("OutboundLink")],1)]),t._v(" "),t._m(40),t._v(" "),r("p",[t._v("TCP的BBR听起来很牛，你知道它是如何达到这个最优点的嘛？")]),t._v(" "),t._m(41),t._v(" "),r("h2",{attrs:{id:"《第13讲-套接字socket：talk-is-cheap-show-me-the-code》"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#《第13讲-套接字socket：talk-is-cheap-show-me-the-code》","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://time.geekbang.org/column/article/9293",target:"_blank",rel:"noopener noreferrer"}},[t._v("《第13讲 | 套接字Socket：Talk is cheap, show me the code》"),r("OutboundLink")],1)]),t._v(" "),t._m(42),t._v(" "),r("p",[t._v("epoll是Linux上的函数，那你知道Windows上对应的机制是什么吗？如果想实现一个跨平台的程序，你知道应该怎么办吗？")]),t._v(" "),t._m(43),t._v(" "),r("p",[t._v("epoll是异步通知，当事件发生的时候，通知应用去调用IO函数获取数据。IOCP异步传输，当事件发生时，IOCP机制会将数据直接拷贝到缓冲区里，应用可以直接使用。")]),t._v(" "),r("p",[t._v("如果跨平台，推荐使用libevent库，它是一个事件通知库，适用于Windows、Linux、BSD等多种平台，内部使用select、epoll、kqueue、IOCP等系统调用管理事件机制。")]),t._v(" "),r("hr"),t._v(" "),r("p",[t._v("感谢第7讲至第13讲中对内容有深度思考和提出问题的同学。我会为你们送上奖励礼券和知识图谱。（稍后运营同学会发送短信通知。）")]),t._v(" "),r("p",[t._v("欢迎你继续提问！")]),t._v(" "),t._m(44),t._v(" "),t._m(45)])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ul",[r("li",[r("p",[t._v("ICMP差错报文（ICMP查询报文可能会产生ICMP差错报文）；")])]),t._v(" "),r("li",[r("p",[t._v("目的地址是广播地址或多播地址的IP数据报；")])]),t._v(" "),r("li",[r("p",[t._v("作为链路层广播的数据报；")])]),t._v(" "),r("li",[r("p",[t._v("不是IP分片的第一片；")])]),t._v(" "),r("li",[r("p",[t._v("源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"留言问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#留言问题","aria-hidden":"true"}},[this._v("#")]),this._v(" 留言问题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/3b/e6/3b2b3f4abaed8a485e8933efbcc304e6.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("void icmp_send(struct sk_buff *skb_in, int type, int code, __be32 info);\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PROT_UNREACH, 0);\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("if (ip_exceeds_mtu(skb, mtu)) {\n  icmp_send(skb, ICMP_DEST_UNREACH, ICMP_FRAG_NEEDED, htonl(mtu));\n  goto drop;\n }\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/a9/fc/a924ccda5d54bcad6f67fdebe0a6c1fc.jpg",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("发给我的，从PREROUTING到INPUT，我就接收了；")])]),this._v(" "),e("li",[e("p",[this._v("我发给别人的，从OUTPUT到POSTROUTING，就发出去的；")])]),this._v(" "),e("li",[e("p",[this._v("从我这里经过的，从PREROUTING到FORWARD到POSTROUTING。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("发给我的，在PREROUTING调用ipv4_conntrack_in，创建连接跟踪记录；在INPUT调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。为什么不一开始就挂在内核的连接跟踪表里面呢？因为有filter表，一旦把包过滤了，也就是丢弃了，那根本没必要记录这个连接了。")])]),this._v(" "),e("li",[e("p",[this._v("我发给别人的，在OUTPUT调用ipv4_conntrack_local，创建连接跟踪记录，在POSTROUTING调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。")])]),this._v(" "),e("li",[e("p",[this._v("从我这里经过的，在PREROUTING调用ipv4_conntrack_in，创建连接跟踪记录，在POSTROUTING调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("如果是PREROUTING的时候，先调用ipv4_conntrack_in，创建连接跟踪记录；")])]),this._v(" "),e("li",[e("p",[this._v("如果是PREROUTING的时候，有NAT规则，则调用nf_nat_ipv4_in进行地址转换；")])]),this._v(" "),e("li",[e("p",[this._v("如果是POSTROUTING的时候，有NAT规则，则调用nf_nat_ipv4_out进行地址转换；")])]),this._v(" "),e("li",[e("p",[this._v("如果是POSTROUTING的时候，调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("nf_conntrack其实才是_nfct变量指向的地址，但是没有关系，学过C++的话应该明白，对于结构体来讲，nf_conn和nf_conntrack的起始地址是一样的；")])]),this._v(" "),e("li",[e("p",[this._v("tuplehash虽然是数组，但是里面只有两个，IP_CT_DIR_ORIGINAL为下标0，表示连接的发起方向，IP_CT_DIR_REPLY为下标1，表示连接的回复方向。")]),this._v(" "),e("p",[this._v("struct nf_conn {\n......\nstruct nf_conntrack ct_general;\n......\nstruct nf_conntrack_tuple_hash tuplehash[IP_CT_DIR_MAX];\n......\nunsigned long status;\n......\n}")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("src：包含源IP地址；如果是TCP或者UDP，包含源端口；如果是ICMP，包含的是ID；")])]),this._v(" "),e("li",[e("p",[this._v("dst：包含目标IP地址；如果是TCP或者UDP，包含目标端口；如果是ICMP，包含的是type, code。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("一去：{源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}；")])]),this._v(" "),e("li",[e("p",[this._v("一回：{源IP：服务端IP，源端口：服务端port，目标IP：客户端IP，目标端口：客户端port}。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("pre",[e("code",[this._v("static inline struct nf_conn *\nnf_ct_tuplehash_to_ctrack(const struct nf_conntrack_tuple_hash *hash)\n{\n return container_of(hash, struct nf_conn,\n       tuplehash[hash->tuple.dst.dir]);\n}\n")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"留言问题-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#留言问题-2","aria-hidden":"true"}},[this._v("#")]),this._v(" 留言问题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/3d/d6/3d9249834f730926c2b2f350aba6e1d6.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/d0/8d/d08e3a727681751037f715c3f5bd398d.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/2d/f1/2d134e61e8cc945c71969be7391b3ff1.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-3","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/b5/da/b5834f4f10c51cb8c91e570bf83f7eda.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"留言问题-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#留言问题-3","aria-hidden":"true"}},[this._v("#")]),this._v(" 留言问题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/18/cd/18040a74506276b23e672d2d818d37cd.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("BGP主要用于互联网AS自治系统之间的互联，BGP的最主要功能在于"),e("strong",[this._v("控制路由的传播")]),this._v("和"),e("strong",[this._v("选择最好的路由")]),this._v("。各大运营商都具有AS号，全国各大网络运营商多数都是通过BGP协议与自身的AS来实现多线互联的。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-4"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-4","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/3c/e1/3cba74151564c129057b2cd246a332e1.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/95/e0/9507374c04e0908f29d5a3050d905fe0.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-5"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-5","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/3c/d7/3c997ad09a1c72cbb32a992e7c9588d7.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"留言问题-4"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#留言问题-4","aria-hidden":"true"}},[this._v("#")]),this._v(" 留言问题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/85/b8/8535df3de9f426b44def750330dcf2b8.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("打开tcp_tw_recycle和tcp_timestamps选项；")])]),this._v(" "),e("li",[e("p",[this._v("打开tcp_tw_reuse和tcp_timestamps选项；")])]),this._v(" "),e("li",[e("p",[this._v("程序中使用SO_LINGER，应用强制使用rst关闭。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("试图连接一个未被监听的服务端；")])]),this._v(" "),e("li",[e("p",[this._v("对方处于TIMEWAIT状态，或者连接已经关闭处于CLOSED状态，或者重新监听seq num不匹配；")])]),this._v(" "),e("li",[e("p",[this._v("发起连接时超时，重传超时，keepalive超时；")])]),this._v(" "),e("li",[e("p",[this._v("在程序中使用SO_LINGER，关闭连接时，放弃缓存中的数据，给对方发送RST。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/af/47/afed5f0593647c0b64971c2fef7e4247.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/c3/e1/c39c723c9389c4414401366a32b69fe1.jpg",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-6"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-6","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/33/03/33b035bd326e9c1f811d667104a54003.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"课后思考题-7"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#课后思考题-7","aria-hidden":"true"}},[this._v("#")]),this._v(" 课后思考题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/74/e9/74d6535a22f5dc8ab2f782b4484ca7e9.png",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/ed/57/edc42141381c0458ab65f70628e88557.jpg",alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://static001.geekbang.org/resource/image/b5/fb/b5bc14cb81d3630919fee94a512cc3fb.jpg",alt:""}})])}],!1,null,null,null);e.default=n.exports}}]);