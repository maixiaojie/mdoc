<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL实战45讲</title>
    <meta name="description" content="从原理到实战，丁奇带你搞懂MySQL">
    <link rel="icon" href="/mysql/logo.png">
    
    <link rel="preload" href="/mysql/assets/css/0.styles.cc2b2df0.css" as="style"><link rel="preload" href="/mysql/assets/js/app.6bab6de6.js" as="script"><link rel="preload" href="/mysql/assets/js/18.3e8b5d49.js" as="script"><link rel="prefetch" href="/mysql/assets/js/10.7bb57ac9.js"><link rel="prefetch" href="/mysql/assets/js/11.3ce52fff.js"><link rel="prefetch" href="/mysql/assets/js/12.7ec4a6d7.js"><link rel="prefetch" href="/mysql/assets/js/13.f4c59903.js"><link rel="prefetch" href="/mysql/assets/js/14.7d5a1716.js"><link rel="prefetch" href="/mysql/assets/js/15.7477677d.js"><link rel="prefetch" href="/mysql/assets/js/16.7d47e096.js"><link rel="prefetch" href="/mysql/assets/js/17.ae5656ba.js"><link rel="prefetch" href="/mysql/assets/js/19.057cfd48.js"><link rel="prefetch" href="/mysql/assets/js/2.b4c10050.js"><link rel="prefetch" href="/mysql/assets/js/20.417f6db0.js"><link rel="prefetch" href="/mysql/assets/js/21.9ae79259.js"><link rel="prefetch" href="/mysql/assets/js/22.06316f7b.js"><link rel="prefetch" href="/mysql/assets/js/23.5561e5be.js"><link rel="prefetch" href="/mysql/assets/js/24.33ee54d8.js"><link rel="prefetch" href="/mysql/assets/js/25.98fa67bc.js"><link rel="prefetch" href="/mysql/assets/js/26.0feba6e9.js"><link rel="prefetch" href="/mysql/assets/js/27.5ed6a467.js"><link rel="prefetch" href="/mysql/assets/js/28.96147e5f.js"><link rel="prefetch" href="/mysql/assets/js/29.d43d39af.js"><link rel="prefetch" href="/mysql/assets/js/3.c0d83c9e.js"><link rel="prefetch" href="/mysql/assets/js/30.176274c0.js"><link rel="prefetch" href="/mysql/assets/js/31.63f671c7.js"><link rel="prefetch" href="/mysql/assets/js/32.343ea5a6.js"><link rel="prefetch" href="/mysql/assets/js/33.60563c22.js"><link rel="prefetch" href="/mysql/assets/js/34.5eed7de7.js"><link rel="prefetch" href="/mysql/assets/js/35.0210d69a.js"><link rel="prefetch" href="/mysql/assets/js/36.dda5aaf9.js"><link rel="prefetch" href="/mysql/assets/js/37.fe0bee8b.js"><link rel="prefetch" href="/mysql/assets/js/38.028209ec.js"><link rel="prefetch" href="/mysql/assets/js/39.11f9433d.js"><link rel="prefetch" href="/mysql/assets/js/4.91286f72.js"><link rel="prefetch" href="/mysql/assets/js/40.952c1390.js"><link rel="prefetch" href="/mysql/assets/js/41.23fafcfb.js"><link rel="prefetch" href="/mysql/assets/js/42.91ce8d1d.js"><link rel="prefetch" href="/mysql/assets/js/43.4e037152.js"><link rel="prefetch" href="/mysql/assets/js/44.fec7f8bd.js"><link rel="prefetch" href="/mysql/assets/js/45.b3c5f4c0.js"><link rel="prefetch" href="/mysql/assets/js/46.56753ead.js"><link rel="prefetch" href="/mysql/assets/js/47.e57136e5.js"><link rel="prefetch" href="/mysql/assets/js/48.b85d0185.js"><link rel="prefetch" href="/mysql/assets/js/49.bf6b62ce.js"><link rel="prefetch" href="/mysql/assets/js/5.a812a305.js"><link rel="prefetch" href="/mysql/assets/js/50.b88ebb49.js"><link rel="prefetch" href="/mysql/assets/js/6.7f198517.js"><link rel="prefetch" href="/mysql/assets/js/7.5376d5b4.js"><link rel="prefetch" href="/mysql/assets/js/8.e979916c.js"><link rel="prefetch" href="/mysql/assets/js/9.1beb90ee.js">
    <link rel="stylesheet" href="/mysql/assets/css/0.styles.cc2b2df0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mysql/" class="home-link router-link-active"><!----> <span class="site-name">MySQL实战45讲</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mysql/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  重学前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/ds/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  数据结构与算法之美
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/netprotocol/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  趣谈网络协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/air/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  左耳听风
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/blockchain/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入浅出区块链
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/webyck/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端面试之道
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/webinter/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Web 前端面试指南与高频考题解析
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/chrome/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  你不知道的 Chrome 调试技巧
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/canvas/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  如何使用 Canvas 制作出炫酷的网页背景特效
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/jvm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入拆解 Java 虚拟机
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mysql/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  重学前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/ds/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  数据结构与算法之美
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/netprotocol/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  趣谈网络协议
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/air/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  左耳听风
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/blockchain/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入浅出区块链
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/webyck/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端面试之道
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/webinter/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Web 前端面试指南与高频考题解析
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/chrome/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  你不知道的 Chrome 调试技巧
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/canvas/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  如何使用 Canvas 制作出炫酷的网页背景特效
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://doc.mcust.cn/jvm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入拆解 Java 虚拟机
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/mysql/article/67888.html" class="sidebar-link">开篇词 | 这一次，让我们一起来搞懂MySQL</a></li><li><a href="/mysql/article/68319.html" class="sidebar-link">01 | 基础架构：一条SQL查询语句是如何执行的？</a></li><li><a href="/mysql/article/68633.html" class="sidebar-link">02  | 日志系统：一条SQL更新语句是如何执行的？</a></li><li><a href="/mysql/article/68963.html" class="sidebar-link">03 | 事务隔离：为什么你改了我还看不见？</a></li><li><a href="/mysql/article/69236.html" class="sidebar-link">04 | 深入浅出索引（上）</a></li><li><a href="/mysql/article/69636.html" class="sidebar-link">05 | 深入浅出索引（下）</a></li><li><a href="/mysql/article/69862.html" class="sidebar-link">06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</a></li><li><a href="/mysql/article/70215.html" class="sidebar-link">07 | 行锁功过：怎么减少行锁对性能的影响？</a></li><li><a href="/mysql/article/70562.html" class="sidebar-link">08 | 事务到底是隔离的还是不隔离的？</a></li><li><a href="/mysql/article/70848.html" class="sidebar-link">09 | 普通索引和唯一索引，应该怎么选择？</a></li><li><a href="/mysql/article/71173.html" class="sidebar-link">10 | MySQL为什么有时候会选错索引？</a></li><li><a href="/mysql/article/71492.html" class="sidebar-link">11 |  怎么给字符串字段加索引？</a></li><li><a href="/mysql/article/71806.html" class="sidebar-link">12 | 为什么我的MySQL会“抖”一下？</a></li><li><a href="/mysql/article/72388.html" class="active sidebar-link">13 | 为什么表数据删掉一半，表文件大小不变？</a></li><li><a href="/mysql/article/72775.html" class="sidebar-link">14 | count(*)这么慢，我该怎么办？</a></li><li><a href="/mysql/article/73161.html" class="sidebar-link">15 | 答疑文章（一）：日志和索引相关问题</a></li><li><a href="/mysql/article/73370.html" class="sidebar-link">直播回顾 | 林晓斌：我的 MySQL 心路历程</a></li><li><a href="/mysql/article/73479.html" class="sidebar-link">16 | “order by”是怎么工作的？</a></li><li><a href="/mysql/article/73795.html" class="sidebar-link">17 | 如何正确地显示随机消息？</a></li><li><a href="/mysql/article/74059.html" class="sidebar-link">18 | 为什么这些SQL语句逻辑相同，性能却差异巨大？</a></li><li><a href="/mysql/article/74687.html" class="sidebar-link">19 | 为什么我只查一行的语句，也执行这么慢？</a></li><li><a href="/mysql/article/75173.html" class="sidebar-link">20 | 幻读是什么，幻读有什么问题？</a></li><li><a href="/mysql/article/75659.html" class="sidebar-link">21 | 为什么我只改一行的语句，锁这么多？</a></li><li><a href="/mysql/article/75746.html" class="sidebar-link">22 | MySQL有哪些“饮鸩止渴”提高性能的方法？</a></li><li><a href="/mysql/article/76161.html" class="sidebar-link">23 | MySQL是怎么保证数据不丢的？</a></li><li><a href="/mysql/article/76446.html" class="sidebar-link">24 | MySQL是怎么保证主备一致的？</a></li><li><a href="/mysql/article/76795.html" class="sidebar-link">25 | MySQL是怎么保证高可用的？</a></li><li><a href="/mysql/article/77083.html" class="sidebar-link">26 | 备库为什么会延迟好几个小时？</a></li><li><a href="/mysql/article/77427.html" class="sidebar-link">27 | 主库出问题了，从库怎么办？</a></li><li><a href="/mysql/article/77636.html" class="sidebar-link">28 | 读写分离有哪些坑？</a></li><li><a href="/mysql/article/78134.html" class="sidebar-link">29 | 如何判断一个数据库是不是出问题了？</a></li><li><a href="/mysql/article/78427.html" class="sidebar-link">30 | 答疑文章（二）：用动态的观点看加锁</a></li><li><a href="/mysql/article/78658.html" class="sidebar-link">31 | 误删数据后除了跑路，还能怎么办？</a></li><li><a href="/mysql/article/79026.html" class="sidebar-link">32 | 为什么还有kill不掉的语句？</a></li><li><a href="/mysql/article/79407.html" class="sidebar-link">33 | 我查这么多数据，会不会把数据库内存打爆？</a></li><li><a href="/mysql/article/79700.html" class="sidebar-link">34 | 到底可不可以使用join？</a></li><li><a href="/mysql/article/80147.html" class="sidebar-link">35 | join语句怎么优化？</a></li><li><a href="/mysql/article/80449.html" class="sidebar-link">36 | 为什么临时表可以重名？</a></li><li><a href="/mysql/article/80477.html" class="sidebar-link">37 | 什么时候会使用内部临时表？</a></li><li><a href="/mysql/article/80495.html" class="sidebar-link">38 | 都说InnoDB好，那还要不要使用Memory引擎？</a></li><li><a href="/mysql/article/80801.html" class="sidebar-link">40 | insert语句的锁为什么这么多？</a></li><li><a href="/mysql/article/81925.html" class="sidebar-link">41 | 怎么最快地复制一张表？</a></li><li><a href="/mysql/article/82231.html" class="sidebar-link">42 | grant之后要跟着flush privileges吗？</a></li><li><a href="/mysql/article/82560.html" class="sidebar-link">43 | 要不要使用分区表？</a></li><li><a href="/mysql/article/83556.html" class="sidebar-link">结束语 | 点线网面，一起构建MySQL知识网络</a></li></ul> </div> <div class="page"> <div class="content"><p>经常会有同学来问我，我的数据库占用空间太大，我把一个最大的表删掉了一半的数据，怎么表文件的大小还是没变？</p> <p>那么今天，我就和你聊聊数据库表的空间回收，看看如何解决这个问题。</p> <p>这里，我们还是针对MySQL中应用最广泛的InnoDB引擎展开讨论。一个InnoDB表包含两部分，即：表结构定义和数据。在MySQL 8.0版本以前，表结构是存在以.frm为后缀的文件里。而MySQL 8.0版本，则已经允许把表结构定义放在系统数据表中了。因为表结构定义占用的空间很小，所以我们今天主要讨论的是表数据。</p> <p>接下来，我会先和你说明为什么简单地删除表数据达不到表空间回收的效果，然后再和你介绍正确回收空间的方法。</p> <h1 id="参数innodb-file-per-table"><a href="#参数innodb-file-per-table" aria-hidden="true" class="header-anchor">#</a> 参数innodb_file_per_table</h1> <p>表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是由参数innodb_file_per_table控制的：</p> <ol><li><p>这个参数设置为OFF表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</p></li> <li><p>这个参数设置为ON表示的是，每个InnoDB表数据存储在一个以 .ibd为后缀的文件中。</p></li></ol> <p>从MySQL 5.6.6版本开始，它的默认值就是ON了。</p> <p>我建议你不论使用MySQL的哪个版本，都将这个值设置为ON。因为，一个表单独存储为一个文件更容易管理，而且在你不需要这个表的时候，通过drop table命令，系统就会直接删除这个文件。而如果是放在共享表空间中，即使表删掉了，空间也是不会回收的。</p> <p>所以，<strong>将innodb_file_per_table设置为ON，是推荐做法，我们接下来的讨论都是基于这个设置展开的。</strong></p> <p>我们在删除整个表的时候，可以使用drop table命令回收表空间。但是，我们遇到的更多的删除数据的场景是删除某些行，这时就遇到了我们文章开头的问题：表中的数据被删除了，但是表空间却没有被回收。</p> <p>我们要彻底搞明白这个问题的话，就要从数据删除流程说起了。</p> <h1 id="数据删除流程"><a href="#数据删除流程" aria-hidden="true" class="header-anchor">#</a> 数据删除流程</h1> <p>我们先再来看一下InnoDB中一个索引的示意图。在前面<a href="https://time.geekbang.org/column/article/69236" target="_blank" rel="noopener noreferrer">第4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://time.geekbang.org/column/article/69636" target="_blank" rel="noopener noreferrer">第5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>篇文章中，我和你介绍索引时曾经提到过，InnoDB里的数据都是用B+树的结构组织的。</p> <p><img src="https://static001.geekbang.org/resource/image/f0/c8/f0b1e4ac610bcb5c5922d0b18563f3c8.png" alt></p> <p>图1 B+树索引示意图</p> <p>假设，我们要删掉R4这个记录，InnoDB引擎只会把R4这个记录标记为删除。如果之后要再插入一个ID在300和600之间的记录时，可能会复用这个位置。但是，磁盘文件的大小并不会缩小。</p> <p>现在，你已经知道了InnoDB的数据是按页存储的，那么如果我们删掉了一个数据页上的所有记录，会怎么样？</p> <p>答案是，整个数据页就可以被复用了。</p> <p>但是，<strong>数据页的复用跟记录的复用是不同的。</strong></p> <p>记录的复用，只限于符合范围条件的数据。比如上面的这个例子，R4这条记录被删除后，如果插入一个ID是400的行，可以直接复用这个空间。但如果插入的是一个ID是800的行，就不能复用这个位置了。</p> <p>而当整个页从B+树里面摘掉以后，可以复用到任何位置。以图1为例，如果将数据页page A上的所有记录删除以后，page A会被标记为可复用。这时候如果要插入一条ID=50的记录需要使用新页的时候，page A是可以被复用的。</p> <p>如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用。</p> <p>进一步地，如果我们用delete命令把整个表的数据删除呢？结果就是，所有的数据页都会被标记为可复用。但是磁盘上，文件不会变小。</p> <p>你现在知道了，delete命令其实只是把记录的位置，或者数据页标记为了“可复用”，但磁盘文件的大小是不会变的。也就是说，通过delete命令是不能回收表空间的。这些可以复用，而没有被使用的空间，看起来就像是“空洞”。</p> <p>实际上，<strong>不止是删除数据会造成空洞，插入数据也会。</strong></p> <p>如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂。</p> <p>假设图1中page A已经满了，这时我要再插入一行数据，会怎样呢？</p> <p><img src="https://static001.geekbang.org/resource/image/80/ea/8083f05a4a4c0372833a6e01d5a8e6ea.png" alt></p> <p>图2 插入数据导致页分裂</p> <p>可以看到，由于page A满了，再插入一个ID是550的数据时，就不得不再申请一个新的页面page B来保存数据了。页分裂完成后，page A的末尾就留下了空洞（注意：实际上，可能不止1个记录的位置是空洞）。</p> <p>另外，更新索引上的值，可以理解为删除一个旧的值，再插入一个新值。不难理解，这也是会造成空洞的。</p> <p>也就是说，经过大量增删改的表，都是可能是存在空洞的。所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。</p> <p>而重建表，就可以达到这样的目的。</p> <h1 id="重建表"><a href="#重建表" aria-hidden="true" class="header-anchor">#</a> 重建表</h1> <p>试想一下，如果你现在有一个表A，需要做空间收缩，为了把表中存在的空洞去掉，你可以怎么做呢？</p> <p>你可以新建一个与表A结构相同的表B，然后按照主键ID递增的顺序，把数据一行一行地从表A里读出来再插入到表B中。</p> <p>由于表B是新建的表，所以表A主键索引上的空洞，在表B中就都不存在了。显然地，表B的主键索引更紧凑，数据页的利用率也更高。如果我们把表B作为临时表，数据从表A导入表B的操作完成后，用表B替换A，从效果上看，就起到了收缩表A空间的作用。</p> <p>这里，你可以使用alter table A engine=InnoDB命令来重建表。在MySQL 5.5版本之前，这个命令的执行流程跟我们前面描述的差不多，区别只是这个临时表B不需要你自己创建，MySQL会自动完成转存数据、交换表名、删除旧表的操作。</p> <p><img src="https://static001.geekbang.org/resource/image/02/cd/02e083adaec6e1191f54992f7bc13dcd.png" alt></p> <p>图3 改锁表DDL</p> <p>显然，花时间最多的步骤是往临时表插入数据的过程，如果在这个过程中，有新的数据要写入到表A的话，就会造成数据丢失。因此，在整个DDL过程中，表A中不能有更新。也就是说，这个DDL不是Online的。</p> <p>而在<strong>MySQL 5.6版本开始引入的Online DDL，对这个操作流程做了优化。</strong></p> <p>我给你简单描述一下引入了Online DDL之后，重建表的流程：</p> <ol><li><p>建立一个临时文件，扫描表A主键的所有数据页；</p></li> <li><p>用数据页中表A的记录生成B+树，存储到临时文件中；</p></li> <li><p>生成临时文件的过程中，将所有对A的操作记录在一个日志文件（row log）中，对应的是图中state2的状态；</p></li> <li><p>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表A相同的数据文件，对应的就是图中state3的状态；</p></li> <li><p>用临时文件替换表A的数据文件。</p></li></ol> <p><img src="https://static001.geekbang.org/resource/image/2d/f0/2d1cfbbeb013b851a56390d38b5321f0.png" alt></p> <p>图4 Online DDL</p> <p>可以看到，与图3过程的不同之处在于，由于日志文件记录和重放操作这个功能的存在，这个方案在重建表的过程中，允许对表A做增删改操作。这也就是Online DDL名字的来源。</p> <p>我记得有同学在第6篇讲表锁的文章<a href="https://time.geekbang.org/column/article/69862" target="_blank" rel="noopener noreferrer">《全局锁和表锁 ：给表加个字段怎么索这么多阻碍？》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的评论区留言说，DDL之前是要拿MDL写锁的，这样还能叫Online DDL吗？</p> <p>确实，图4的流程中，alter语句在启动的时候需要获取MDL写锁，但是这个写锁在真正拷贝数据之前就退化成读锁了。</p> <p>为什么要退化呢？为了实现Online，MDL读锁不会阻塞增删改操作。</p> <p>那为什么不干脆直接解锁呢？为了保护自己，禁止其他线程对这个表同时做DDL。</p> <p>而对于一个大表来说，Online DDL最耗时的过程就是拷贝数据到临时表的过程，这个步骤的执行期间可以接受增删改操作。所以，相对于整个DDL过程来说，锁的时间非常短。对业务来说，就可以认为是Online的。</p> <p>需要补充说明的是，上述的这些重建方法都会扫描原表数据和构建临时文件。对于很大的表来说，这个操作是很消耗IO和CPU资源的。因此，如果是线上服务，你要很小心地控制操作时间。如果想要比较安全的操作的话，我推荐你使用GitHub开源的gh-ost来做。</p> <h1 id="online-和-inplace"><a href="#online-和-inplace" aria-hidden="true" class="header-anchor">#</a> Online 和 inplace</h1> <p>说到Online，我还要再和你澄清一下它和另一个跟DDL有关的、容易混淆的概念inplace的区别。</p> <p>你可能注意到了，在图3中，我们把表A中的数据导出来的存放位置叫作tmp_table。这是一个临时表，是在server层创建的。</p> <p>在图4中，根据表A重建出来的数据是放在“tmp_file”里的，这个临时文件是InnoDB在内部创建出来的。整个DDL过程都在InnoDB内部完成。对于server层来说，没有把数据挪动到临时表，是一个“原地”操作，这就是“inplace”名称的来源。</p> <p>所以，我现在问你，如果你有一个1TB的表，现在磁盘间是1.2TB，能不能做一个inplace的DDL呢？</p> <p>答案是不能。因为，tmp_file也是要占用临时空间的。</p> <p>我们重建表的这个语句alter table t engine=InnoDB，其实隐含的意思是：</p> <pre><code>alter table t engine=innodb,ALGORITHM=inplace;
</code></pre> <p>跟inplace对应的就是拷贝表的方式了，用法是：</p> <pre><code>alter table t engine=innodb,ALGORITHM=copy;
</code></pre> <p>当你使用ALGORITHM=copy的时候，表示的是强制拷贝表，对应的流程就是图3的操作过程。</p> <p>但我这样说你可能会觉得，inplace跟Online是不是就是一个意思？</p> <p>其实不是的，只是在重建表这个逻辑中刚好是这样而已。</p> <p>比如，如果我要给InnoDB表的一个字段加全文索引，写法是：</p> <pre><code>alter table t add FULLTEXT(field_name);
</code></pre> <p>这个过程是inplace的，但会阻塞增删改操作，是非Online的。</p> <p>如果说这两个逻辑之间的关系是什么的话，可以概括为：</p> <ol><li><p>DDL过程如果是Online的，就一定是inplace的；</p></li> <li><p>反过来未必，也就是说inplace的DDL，有可能不是Online的。截止到MySQL 8.0，添加全文索引（FULLTEXT index）和空间索引(SPATIAL index)就属于这种情况。</p></li></ol> <p>最后，我们再延伸一下。</p> <p>在第10篇文章<a href="https://time.geekbang.org/column/article/71173" target="_blank" rel="noopener noreferrer">《MySQL为什么有时候会选错索引》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的评论区中，有同学问到使用optimize table、analyze table和alter table这三种方式重建表的区别。这里，我顺便再简单和你解释一下。</p> <ul><li>从MySQL 5.6版本开始，alter table t engine = InnoDB（也就是recreate）默认的就是上面图4的流程了；</li> <li>analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了MDL读锁；</li> <li>optimize table t 等于recreate+analyze。</li></ul> <h1 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h1> <p>今天这篇文章，我和你讨论了数据库中收缩表空间的方法。</p> <p>现在你已经知道了，如果要收缩一个表，只是delete掉表里面不用的数据的话，表文件的大小是不会变的，你还要通过alter table命令重建表，才能达到表文件变小的目的。我跟你介绍了重建表的两种实现方式，Online DDL的方式是可以考虑在业务低峰期使用的，而MySQL 5.5及之前的版本，这个命令是会阻塞DML的，这个你需要特别小心。</p> <p>最后，又到了我们的课后问题时间。</p> <p>假设现在有人碰到了一个“想要收缩表空间，结果适得其反”的情况，看上去是这样的：</p> <ol><li><p>一个表t文件大小为1TB；</p></li> <li><p>对这个表执行 alter table t engine=InnoDB；</p></li> <li><p>发现执行完成后，空间不仅没变小，还稍微大了一点儿，比如变成了1.01TB。</p></li></ol> <p>你觉得可能是什么原因呢 ？</p> <p>你可以把你觉得可能的原因写在留言区里，我会在下一篇文章的末尾把大家描述的合理的原因都列出来，以后其他同学就不用掉到这样的坑里了。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p> <h1 id="上期问题时间"><a href="#上期问题时间" aria-hidden="true" class="header-anchor">#</a> 上期问题时间</h1> <p>在上期文章最后，我留给你的问题是，如果一个高配的机器，redo log设置太小，会发生什么情况。</p> <p>每次事务提交都要写redo log，如果设置太小，很快就会被写满，也就是下面这个图的状态，这个“环”将很快被写满，write pos一直追着CP。</p> <p><img src="https://static001.geekbang.org/resource/image/a2/e5/a25bdbbfc2cfc5d5e20690547fe7f2e5.jpg" alt></p> <p>这时候系统不得不停止所有更新，去推进checkpoint。</p> <p>这时，你看到的现象就是<strong>磁盘压力很小，但是数据库出现间歇性的性能下跌。</strong></p> <p>评论区留言点赞板：</p> <blockquote><p>@某、人 给了一个形象的描述，而且提到了，在这种情况下，连change buffer的优化也失效了。因为checkpoint一直要往前推，这个操作就会触发merge操作，然后又进一步地触发刷脏页操作；<br>
有几个同学提到了内存淘汰脏页，对应的redo log的操作，这个我们会在后面的文章中展开，大家可以先看一下 @melon 同学的描述了解一下；<br>
@算不出流源 提到了“动态平衡”，其实只要出现了这种“平衡”，意味着本应该后台的操作，就已经影响了业务应用，属于有损失的平衡。</p></blockquote> <p><img src="https://static001.geekbang.org/resource/image/ce/d9/ce7f4e35916ed1aa49206a53a0547bd9.jpg" alt></p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/mysql/article/71806.html" class="prev">
          12 | 为什么我的MySQL会“抖”一下？
        </a></span> <span class="next"><a href="/mysql/article/72775.html">
          14 | count(*)这么慢，我该怎么办？
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/mysql/assets/js/app.6bab6de6.js" defer></script><script src="/mysql/assets/js/18.3e8b5d49.js" defer></script>
  </body>
</html>
